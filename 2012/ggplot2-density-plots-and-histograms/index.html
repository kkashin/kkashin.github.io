<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> ggplot2: Density Plots and Histograms | Konstantin Kashin </title> <meta name="description" content=" Konstantin Kashin is an Engineering Manager at Meta, interested in AI, causal inference, experimentation, and optimization. "> <meta name="keywords" content="artificial intelligence, AI, data science, engineering, causal inference, A/B testing, experimentation, optimization"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Konstantin Kashin"> <meta property="article:section" content="blog"> <meta property="article:tag" content=""> <meta property="article:published_time" content="2012-04-10 00:00:00 -0400"> <meta property="og:url" content="http://localhost:4000/2012/ggplot2-density-plots-and-histograms/"> <meta property="og:title" content=" ggplot2: Density Plots and Histograms | Konstantin Kashin "> <meta property="og:image" content="http://localhost:4000"> <meta property="og:description" content=" Konstantin Kashin is an Engineering Manager at Meta, interested in AI, causal inference, experimentation, and optimization. "> <meta property="og:site_name" content="Konstantin Kashin"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content=""> <meta name="twitter:title" content=" ggplot2: Density Plots and Histograms | Konstantin Kashin "> <meta name="twitter:description" content=" Konstantin Kashin is an Engineering Manager at Meta, interested in AI, causal inference, experimentation, and optimization. "> <meta name="twitter:image:src" content="http://localhost:4000"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" ggplot2: Density Plots and Histograms | Konstantin Kashin "> <meta itemprop="description" content=" Konstantin Kashin is an Engineering Manager at Meta, interested in AI, causal inference, experimentation, and optimization. "> <meta itemprop="image" content="http://localhost:4000"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="shortcut icon" type="image/png" href="/assets/images/favicon-32x32.png"> <!-- Canonical link tag --> <link rel="canonical" href="http://localhost:4000/2012/ggplot2-density-plots-and-histograms/"> <link rel="alternate" type="application/rss+xml" title="Konstantin Kashin" href="http://localhost:4000/feed.xml"> <script type="text/javascript"> var disqus_shortname = ''; var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-29054835-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> <!-- MathJax scripts --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']], displayMath: [['\\[','\\]'], ['$$','$$']]}}); </script> <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">Konstantin Kashin<span></span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/projects">projects</a></li> <li><a href="/data">data</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">ggplot2: Density Plots and Histograms</h1> <p class="post-meta"><time datetime="2012-04-10T00:00:00-04:00" itemprop="datePublished">Apr 10, 2012</time></p> </header> <div class="post-content" itemprop="articleBody"> <p>In this post, I’m going to go through how to make plots of distributions (either density plots or histograms) in ggplot2. I’m going to draw upon examples of Fisherian testing in the context of causal inference, but the examples should be completely understandable without knowledge of Fisher’s approach to inference.</p> <p>For example, suppose that we want to plot the randomization distribution of a test statistic (difference in means in this case) under the sharp null of zero treatment effect across all units. The possible values of the test statistic across 1000 randomly sampled randomizations are in the vector <code>test.stat</code>. Moreover, the actually observed test statistic is <code>tau.hat</code>. Not only do we want to plot the density, but we want to shade in the area under the density that corresponds to the one-sided p-value of this test statistic.</p> <p>We can first turn the vector into a data frame that contains the values as x and the corresponding density as y:</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">dd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">with</span><span class="p">(</span><span class="n">density</span><span class="p">(</span><span class="n">test.stat</span><span class="p">),</span><span class="n">data.frame</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span></code></pre></figure> <p>Then in <code>ggplot</code>:</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dd</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_line</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">layer</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dd</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ifelse</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tau.hat</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">tau.hat</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"area"</span><span class="p">,</span><span class="w"> </span><span class="n">geom_params</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">.3</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">dd</span><span class="o">$</span><span class="n">y</span><span class="p">)),</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">"Density"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Difference in Means"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_vline</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">tau.hat.1a</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="s2">"dashed"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_text</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text2</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data.frame</span><span class="p">(</span><span class="n">x2</span><span class="o">=</span><span class="m">-42</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="o">=</span><span class="m">0.015</span><span class="p">,</span><span class="w"> </span><span class="n">text2</span><span class="o">=</span><span class="s2">"T[obs]"</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">I</span><span class="p">(</span><span class="s2">"red"</span><span class="p">),</span><span class="w"> </span><span class="n">parse</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_text</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text2</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data.frame</span><span class="p">(</span><span class="n">x2</span><span class="o">=</span><span class="m">-60</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="o">=</span><span class="m">0.0025</span><span class="p">,</span><span class="w"> </span><span class="n">text2</span><span class="o">=</span><span class="s2">"p-value = 0.041"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">3</span><span class="p">)</span></code></pre></figure> <div class="post-image"> <a href="/assets/images/blog/randomization_dist.jpg"><img alt="randomization distribution" src="/assets/images/blog/randomization_dist.jpg" height="320" width="320" /></a> </div> <p>Several comments on the syntax passed to the <code>ggplot()</code> function above:</p> <ul> <li>The <code>layer()</code> function with the <code>geom="area"</code> option fills the area under the distribution corresponding to the one-sided p-value (probability of observing a value of the test statistic at least as small as the one we observe).</li> <li>manually pass the location of the text into the <code>geom_text()</code> function in this case by creating a data frame within the actual <code>geom_text()</code> function.</li> <li>Note that in order for <code>ggplot</code> to write expressions with text, such as subscripts which I use above, I pass the <code>parse=TRUE</code> option to <code>geom_text()</code>.</li> </ul> <p><br /> Here’s another example that involves plotting the distribution of p-values under the sharp null of a constant additive treatment effect for each unit. I wanted to plot the values of the resultant test statistics on the x-axis, the p-values for the sharp null on the y-axis, and then shade the 95% Fisherian confidence interval. In this case, <code>tau.vector</code> contains the values of the test statistic (difference in means). <code>p.vector</code> is a corresponding vector that contains the one-sided exact Fisher p-value for the sharp null hypothesis that the effect is 0. Note that I placed a dotted horizontal red line at a p-value of 0.025 to obtain approximately 95% coverage on my confidence interval.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI.2c</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau.vector</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p.vector</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_line</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">CI.2c</span><span class="o">$</span><span class="n">p.vector</span><span class="p">)),</span><span class="n">name</span><span class="o">=</span><span class="s2">"p-value"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Difference in Means"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">layer</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CI.2c</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ifelse</span><span class="p">((</span><span class="n">lb.2c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tau.vector</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">tau.vector</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ub.2c</span><span class="p">),</span><span class="n">tau.vector</span><span class="p">,</span><span class="n">lb.2c</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">p.vector</span><span class="p">),</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"area"</span><span class="p">,</span><span class="w"> </span><span class="n">geom_params</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">.3</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_hline</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="m">0.025</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="s2">"dashed"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_text</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text2</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data.frame</span><span class="p">(</span><span class="n">x2</span><span class="o">=</span><span class="m">-100</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">text2</span><span class="o">=</span><span class="s2">"95% CI: [-83,6.33]"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">5</span><span class="p">)</span></code></pre></figure> <div class="post-image"> <a href="/assets/images/blog/pval_density.jpg"><img alt="p-value distribution" src="/assets/images/blog/pval_density.jpg" height="320" width="320" /></a> </div> <p>Here’s a very simple histogram example. Suppose that <code>pval.5</code> contains a vector of p-values across all possible assignment vectors. We want to plot the distribution of Fisher’s exact p-values, which should be uniformly distributed between 0 and 1 under the null (and generally when dealing with continuous test statistics). We can do so simply using ggplot as:</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pval.5</span><span class="p">),</span><span class="w"> </span><span class="n">binwidth</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">.25</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"p-value"</span><span class="p">)</span></code></pre></figure> <div class="post-image"> <a href="/assets/images/blog/pval_hist.jpg"><img alt="p-value histogram" src="/assets/images/blog/pval_hist.jpg" height="320" width="320" /></a> </div> </div> <div class="post-nav"> <a rel="prev" class="prev" href="/2012/ggplot2-side-by-side-plots/">&larr; ggplot2: Side-by-Side Plots</a> <a rel="next" class="next" href="/2012/favorite-applications-for-os-x/">Favorite applications for OS X &rarr;</a> </div> </article> <footer class="site-footer"> <div class="container"> <small class="pull-left">&copy;2024 Konstantin Kashin. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>.</small> <small class="pull-right"> <ul class="contact-list"> <li> <a href="https://linkedin.com/in/konstantin-kashin-8939a492"><span class="icon"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn icon</title><path fill="#828282" d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg> </span></a> </li> <li> <a href="https://github.com/kkashin"><span class="icon icon--github"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path fill="#828282" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg> </span></a> </li> <li> <a href="https://twitter.com/@kostyakashin"><span class="icon icon--twitter"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter icon</title><path fill="#828282" d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg> </span></a> </li> </ul></small> </div> </footer> </main> </body> </html>
